<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <title>#TwitterThrowback</title>
    <meta name="description" content="See what you've Tweeted on this day in the past.">
    <link href="https://fonts.googleapis.com/css?family=Maven+Pro:400,500" rel="stylesheet">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://oldtweets.today/">
    <meta property="og:title" content="#TwitterThrowback">
    <meta property="og:description" content="See what you've Tweeted on this day in the past.">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary">
    <meta property="twitter:url" content="http://oldtweets.today/">
    <meta property="twitter:title" content="#TwitterThrowback">
    <meta property="twitter:description" content="See what you've Tweeted on this day in the past.">

    <!--favicon-->
    <link rel="icon" href="img/favicon.ico" type="image/x-icon"/>

    <style>
        #tweets-container {
            padding-top: 10px;
            display: none;
        }
    </style>

    <style>
        html{
            scroll-behavior: smooth;
        }

        body{
            margin: 0;
            padding: 0;
            font-size: 15px;
            text-align: center;
        }

        *{
            box-sizing: border-box;
        }

        a{
            color: #1B95E0;
            font-weight: 500;
            text-decoration: none;
            transition: 0.3s;
        }

        a:hover{
            color: #525759;
        }

        b{
            font-weight: 500;
        }

        .wrapper{
            color: #525759;
            display: flex;
            flex-direction: column;
            font-family: 'Maven Pro', sans-serif;
            justify-content: center;
            min-height: 100%;
            padding: 50px;
            transition: 0.3s;
        }

        .wrapper.successful{
            padding: 20px 50px 50px;
        }

        .wrapper.successful h3,
        .wrapper.successful .help-text{
            display: none;
        }

        .wrapper.successful .form{
            max-width: 500px;
        }

        .wrapper h2,
        .wrapper h3{
            font-weight: 400;
            margin: 0 0 25px;
            padding: 0;
            text-align: center;
        }

        .wrapper h2{
            color: #1B95E0;
            font-size: 35px;
            line-height: 45px;
            margin: 0 0 10px;
        }

        .wrapper h2 span{
            font-weight: 500;
        }

        .wrapper h3{
            font-size: 20px;
            line-height: 30px;
        }

        .form{
            margin: 0 auto 25px;
            max-width: 650px;
            overflow: hidden;
        }

        .form__input{
            background: #ffffff;
            border: 1px solid rgba(0, 0, 0, 0.25);
            border-radius: 5px 0 0 5px;
            border-right: none;
            color: #525759;
            display: inline-block;
            float: left;
            font-family: 'Maven Pro', sans-serif;
            font-size: 16px;
            height: 50px;
            line-height: 20px;
            max-width: 100%;
            outline: none;
            padding: 15px;
            transition: 0.3s ease-in-out;
            width: calc(100% - 120px);
        }

        .form__input:focus{
            border-color: #1B95E0;
        }

        .form__button{
            background: #1B95E0;
            border: none;
            border-radius: 0 5px 5px 0;
            color: #ffffff;
            cursor: pointer;
            display: inline-block;
            float: left;
            font-family: 'Maven Pro', sans-serif;
            font-size: 16px;
            height: 50px;
            line-height: 20px;
            outline: none;
            padding: 15px;
            position: relative;
            width: 120px;
        }

        .form__button[disabled]{
            opacity: 0.65;
            cursor: no-drop;
        }

        .form__button[disabled]:after{
            background: #1B95E0;
            border-radius: 0 5px 5px 0;
            content: "loading . . .";
            display: block;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            line-height: 50px;
            width: 100%;
        }

        .help-text{
            font-size: 18px;
            font-weight: 400;
            margin: 0 0 15px;
            text-align: center;
        }

        .loading{
            border: 1px solid transparent;
            border-radius: 5px;
            display: none;
            font-size: 16px;
            line-height: 20px;
            margin: 50px auto 0;
            max-width: 650px;
            padding: 14px;
        }

        .loading.show{
            display: block;
        }

        .loading.error{
            border-color: #E25E5E;
            color: #E25E5E;
        }

        .share,
        .to-top{
            background: #1B95E0;
            border: none;
            border-radius: 25px;
            bottom: 20px;
            cursor: pointer;
            font-size: 16px;
            height: 50px;
            outline: none;
            position: fixed;
            text-align: center;
            transition: 0.3s;
            width: 50px;
        }

        .share{
            align-items: center;
            display: flex;
            justify-content: center;
            left: 20px;
        }

        .share img{
            display: inline-block;
            width: 20px;
        }

        .share:after{
            content: attr(title);
            color: #ffffff;
            display: inline-block;
            font-family: 'Maven Pro', sans-serif;
            font-size: 13px;
            line-height: 25px;
            margin-left: 5px;
            transition: 0.5s;
            overflow: hidden;
            white-space: nowrap;
            width: 0;
        }

        .share:hover:after{
            width: calc(100% - 35px);
        }

        .share:hover{
            width: 150px;
        }

        .to-top{
            opacity: 0;
            right: 20px;
            visibility: hidden;
        }

        .to-top.visible{
            opacity: 1;
            visibility: visible;
        }

        .to-top span{
            margin-left: 5px;
        }
    </style>

    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</head>

<body>
<section id="site-wrapper" class="wrapper">
    <header>
        <h2>#Twitter<span>Throwback</span></h2>
        <h3>See what you've tweeted on this day in the past.</h3>
    </header>
    <main>
        <form onsubmit="handleFormSubmit(event);" class="form">
            <input id="username-input" type="text" name="username" autofocus class="form__input" placeholder="Your Twitter username" autocomplete="off" required>
            <button id="submit-button" class="form__button" type="submit">Show me</button>
        </form>
        <aside class="help-text">
            If your profile is protected üîí, you'll need to <a href="https://help.twitter.com/en/safety-and-security/how-to-make-twitter-private-and-public" target="_blank">unlock it first</a>.
        </aside>
        <aside class="help-text">
            Developer üíª? <a href="//github.com/shalvah/oldtweets.today" target="_blank">Check out the source code</a> üëÄ
        </aside>

        <aside id="loading-indicator" class="loading"></aside>

        <section id="tweets-container"></section>
    </main>
</section>

<button onclick="shareToTwitter()" id="shareButton" class="share" title="Share on Twitter">
    <img src="./img/twitter-icon.svg">
</button>
<button onclick="backToTop()" id="topBtn" class="to-top" title="Back to top"><span>üëÜ</span></button>

<script>
    var siteWrapper = document.getElementById('site-wrapper');
    var tweetsContainer = document.getElementById('tweets-container');
    var usernameInput = document.getElementById('username-input');
    var submitButton = document.getElementById('submit-button');
    var loadingIndicator = document.getElementById('loading-indicator');
</script>
<script>
    // Prefill the value if the user is coming from a direct link (oldtweets.today/#username)
    // Normally, I'd want to do this using a path, but GitHub Pages doesn't support routing via paths
    let hash = window.location.hash.split('#')[1];
    if (hash != '' && hash != undefined) {
        usernameInput.value = hash;
    } else {
        // Also support query string (oldtweets.today?username=<username>)
        let queryString = window.location.search;
        let queryParams = new URLSearchParams(queryString);
        if (queryParams.get('username')) {
            usernameInput.value = queryParams.get('username');
        }
    }
</script>

<script>
    function showLoadingIndicator() {
        submitButton.disabled = true;
        loadThatShit();
    }

    function doneWithLoading(succesful = true) {
        clearInterval(window.loaderInterval);
        succesful && (loadingIndicator.innerText = "Done! ‚úÖ");
        setTimeout(() => {
            submitButton.removeAttribute('disabled');
            succesful && (loadingIndicator.classList.remove('show'));
            succesful && (tweetsContainer.style.display = 'block');
            succesful && (siteWrapper.classList.add('successful'));
        }, 1000);
    }

    function loadThatShit() {
        loadingIndicator.innerText = `Fetching ${window.username}'s tweets from ${day}...just a sec üöÄ`;
        loadingIndicator.classList.add('show');
        loadingIndicator.classList.remove('error');
        emojiLoad();
    }

    function emojiLoad() {
        window.loaderInterval = setInterval(() => {
            let emojis = ['ü§î', 'üìù', 'üë©‚Äçüè≠', 'ü§ó', 'üôà', 'üò∏', 'üôÇ', 'üòÖ', 'üí™', 'üòä'];
            loadingIndicator.innerText = `Fetching ${window.username}'s tweets from ${day}...just a sec ${emojis[Math.floor(Math.random() * emojis.length)]}`;
        }, 750);
    }
</script>
<script>
    /**
     * @param {Event} event
     */
    function handleFormSubmit(event) {
        event.preventDefault();
        window.username = usernameInput.value;
        window.username = window.username.trim();

        history.pushState({username}, '', '#' + username);
        window.day = (new Date).toLocaleString('en-us', {month: 'long', day: 'numeric'});

        showLoadingIndicator();
        // get rid of any existing content
        tweetsContainer.innerHTML = '';
        getTweetsOnThisDay(username)
            .then(tweets => {
                let tweetsHtml = [];
                let hasContent = false;
                for (let year of Object.keys(tweets).reverse()) {
                    if (tweets[year].length) {
                        hasContent = true;
                        tweetsHtml.push(`<div>`);
                        tweetsHtml.push(`<h3>${year}</h3>`);
                        tweetsHtml.push(tweets[year].join("\n"));
                        tweetsHtml.push("</div><br>");
                    }
                }

                if (!hasContent) {
                    throw `Sorry, we couldn't find any tweets by <b>${window.username}</b> on <b>${window.day}</b>üòï`;
                }

                injectContentIntoPage(tweetsHtml.join("\n"), true);
                document.title = `@${username.replace("@", "")}'s old Tweets`;
            })
            .catch(showError);
    }

    /**
     * @param {string} username
     */
    function getTweetsOnThisDay(username) {
        const today = new Date();
        const utcOffset = today.getTimezoneOffset();
        const baseApiUrl = `https://europe-west1-tweetedonthisday.cloudfunctions.net/getTweetsOnThisDay?username=${username}&utcOffset=${utcOffset}`;
        let baseYear = today.getFullYear() - 1;
        let years = [];
        // request in three-year batches to improve speed
        while (baseYear > 2005) {
            let endYear = baseYear - 2;
            if ((endYear - 2006) < 2) {
                endYear = 2006;
            }
            years.push([baseYear, endYear]);
            baseYear = endYear - 1;
        }

        let apiUrls = years.map(yearSet => `${baseApiUrl}&from=${yearSet[0]}&until=${yearSet[1]}`);

        return Promise.all(apiUrls.map(url => fetch(url)))
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(responses => {
                // this would be simpler, but I have a suspicion it's slower
                // return Object.assign({}, ...responses);

                let results = responses.reduce((all, r) => {
                    for (let year in r) {
                        all[year] = r[year];
                    }
                    return all;
                }, {});
                return results;
            })
            .catch(r => {
                if (r.error) {
                    console.log(r.error);
                }
                console.log(r);
                throw 'Something went wrong. Please try again.üò≠';
            })
    }

    /**
     * @param {string} content
     */
    function injectContentIntoPage(content) {
        twttr.events.bind('loaded', () => setTimeout(doneWithLoading, 1000));
        let container = document.getElementById('tweets-container');
        container.innerHTML = content;
        twttr.widgets.load(container);
    }

    function showError(message) {
        doneWithLoading(false);
        setTimeout(() => {
            loadingIndicator.classList.add('error', 'show');
            loadingIndicator.innerHTML = message;
        }, 1000);
    }

    function shareToTwitter() {
        let url;
        if (window.username !== undefined) {
            url = `http://twitter.com/share?text=Here's my TwitterThrowback. Check yours here` +
                `&url=http://oldtweets.today/?username=${window.username}&hashtags=OldTweetsToday,TwitterThrowback`;
        }
        else {
            url = `http://twitter.com/share?text=Wanna see what you were tweeting on this day in the past? Check out ` +
                `&url=http://oldtweets.today/&hashtags=OldTweetsToday,TwitterThrowback`;
        }
        const newWindow = window.open(url, '_blank');

        newWindow.focus();

    }
</script>
<script>
    // When the user scrolls down 30px from the top of the document, show the button
    window.onscroll = () => {
        scrollDown()
    };

    function scrollDown() {
        if (document.body.scrollTop > 30 || document.documentElement.scrollTop > 30) {
            document.getElementById("topBtn").classList.add('visible');
        } else {
            document.getElementById("topBtn").classList.remove("visible");
        }
    }

    // When the user clicks on the button, scroll to the top of the document
    function backToTop() {
        document.body.scrollTop = 0;
        document.documentElement.scrollTop = 0;
    }
</script>
</body>
